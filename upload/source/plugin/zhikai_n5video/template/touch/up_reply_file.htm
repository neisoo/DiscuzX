<!--{block file}-->
<link href="source/plugin/zhikai_n5video/static/css/style.css" rel="stylesheet" />
<link href="source/plugin/zhikai_n5video/uikit/css/uikit.docs.min.css" rel="stylesheet" />
<link href="source/plugin/zhikai_n5video/uikit/css/components/progress.css " rel="stylesheet" />
<link rel="stylesheet" href="source/plugin/zhikai_n5video/video-js/video-js.min.css">

<script type="text/javascript"src="source/plugin/zhikai_n5video/static/js/jquery.min.js"></script>
<script type="text/javascript" src="source/plugin/zhikai_n5video/static/js/jquery.shardupload.js"></script>
<script type="text/javascript" src="source/plugin/zhikai_n5video/static/js/jquery.scroll.js"></script>
<script type="text/javascript" src="source/plugin/zhikai_n5video/uikit/js/uikit.min.js"></script>
<script type="text/javascript" src="source/plugin/zhikai_n5video/video-js/video.js"></script>
<script type="text/javascript" src="source/plugin/zhikai_n5video/mp3-recorder/recorder.js"></script>

<style>
::cue {
	background: none;
	color: #fff;
	text-shadow: 0 1px #000, 1px 0 #000, -1px 0 #000, 0 -1px #000;
	font-size: medium;
}
::cue(v[voice=hanhan]) {
	color: green;
}
::cue(.red) {
	color: red;
}

.fixed_div {
	width: 100%;
	position: fixed;
	background: #e5e5e5;
	top: 0;
	z-index: 1000;
	left: 0px;
	border: 1px solid red;
}

.sentence_wrap {
	padding-top: 100px; /* 句子列表距顶部的距离 */
	padding-left: 10px;
	padding-right: 10px;
}

.vidoe_wrap{
	width:100%;
	position:relative;
	padding-bottom:62%; /*需要用padding来维持16:9比例,也就是9除以16*/
	height: 0;
	video{
		position: absolute;
		top:0;
		left: 0;
		width: 100%;
		height: 100%
	}
}

/* 显示当前时间和总时间 */
.video-js .vjs-time-control {
    display: block;
}
.video-js .vjs-remaining-time {
    display: none;
}

.sentence-play-button, .sentence-record-button{
	color: white;
	width: 48px;
	height: 48px;
	font-size: 22px;
	border-radius: 50%;
}

.uk-panel-title {
    margin-bottom: 6px;
}

.uk-article-divider {
    margin-top: 6px;
    margin-bottom: 6px;
}
</style>

<div class="zhikai-player cl fixed_div">
<video id="video_{$_G[tid]}" class="video-js vjs-default-skin vjs-big-play-centered vidoe_wrap">
	<source src="{$attachInfo[video]}" type='video/mp4'>
	<p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that<a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
	<!--{if attachInfo['subtitle'] != null}-->
	<track kind="subtitles" src="{$attachInfo[subtitle]}" srclang="en" id="original" label="{lang zhikai_n5video:lang_068}" default></track>
	<!--{/if}--> 
	<!--{if $attachInfo['tsubtitle'] != null}-->
	<track kind="subtitles" src="{$attachInfo[tsubtitle]}" srclang="zh" id="translation" label="{lang zhikai_n5video:lang_069}"></track>
	<!--{/if}--> 
</video>
</div>
<div id="sutitle_list" class="sentence_wrap">
</div>
<!--{if $attachInfo['accompany'] != null}-->
<audio id="accompany" src="{$attachInfo[accompany]}"></audio>
<!--{/if}--> 
<audio id="startRecordSnd" src="source/plugin/zhikai_n5video/di.ogg"></audio>

<script type="text/javascript">
var jq = jQuery.noConflict();

var videoOptions = {
	poster: '{$attachInfo[cover]}',
	controls: true,
	playbackRates: [0.5, 0.75, 1, 1.5, 2],
	controlBar: {
		playToggle: false,
		volumePanel: false,
		currentTimeDisplay: true,
		durationDisplay: true,
		remainingTimeDisplay: false,
		progressControl: true,
		fullscreenToggle: false,
		chaptersButton: false,
		descriptionsButton: false,
		subsCapsButton: false,
		AudioTrackButton: true,
	},
	// 禁用自带来的bigPlayButton。
	children: ['mediaLoader', 'posterImage', 'textTrackDisplay', 'loadingSpinner', /*'bigPlayButton',*/ 'controlBar', 'errorDisplay', 'textTrackSettings', 'resizeManager', 'audioTrackButton'],
	inactivityTimeout: -1, // 不要超时inactive.
	
};

var startRecordSnd = jq('#startRecordSnd')[0]; // 录音开始提示音。
var player = videojs('video_{$_G[tid]}', videoOptions);
var subtitleInit = false;
var subtitleCount = 0;
var subtitleCurrent = -1;
var sentenceStartTime = 0;
var sentenceEndTime = 0;

var recordPlayer = null;
var accompanyPlayer = null;
if (jq('#accompany').length > 0) {
	accompanyPlayer = jq('#accompany')[0];
}

var playStatus = 0; // =0原音播放或暂停中，=1用户录音中，=2回放用户录音中

player.on("ready", function(){
	var origTrack = player.textTracks().getTrackById("original");
	var transTrack = player.textTracks().getTrackById("translation");

	// 强制加载所有的字幕。
	if (origTrack != null) {
		origTrack.mode = 'showing';
	}
	
	if (transTrack != null) {
		transTrack.mode = 'showing';
	}
});

player.on("canplay", function(){
	
	if (!subtitleInit) {
		subtitleInit = true;

		var origTrack = player.textTracks().getTrackById("original");
		var transTrack = player.textTracks().getTrackById("translation");
		
		// 获取原文、译文和时间段。
		if (origTrack) {
			subtitleCount = origTrack.cues.length;
			for (var i = 0; i < subtitleCount; i++) {
				var cue = origTrack.cues[i];

				var dom ='<div class="uk-grid data-uk-grid-margin uk-grid-small">'
					+	'<div class="uk-width-1-1 uk-row-first">'
					+		'<div class="uk-panel uk-panel-box" id="sentence_' + i + '" startTime="' + cue.startTime + '" endTime="' + cue.endTime + '">'
					+			'<div class="uk-panel-badge uk-badge">Hot</div>'
					+			'<h3 class="uk-panel-title">' + (i + 1) + '/' + subtitleCount + '</h3>'
					+			'<p style="color:black;">' + cue.text + '</b></p>';

				// 译文
				if (transTrack && transTrack.cues && transTrack.cues[i]) {
					dom +=		'<p>' + transTrack.cues[i].text + '</p>';
				}
				dom +=			'<hr class="uk-article-divider">';
				dom +=			'<div class="uk-grid uk-grid-small">';
				dom +=				'<div class="uk-width-3-6 uk-vertical-align">';
				dom +=					'<div class="uk-panel uk-width-1-1 uk-vertical-align-middle">';
				dom +=						'<div class="uk-progress uk-progress-mini">';
				dom +=							'<div id="record_progress_' + i + '" class="uk-progress-bar" style="width: 0%;"></div>';
				dom +=						'</div>';
				dom +=					'</div>';
				dom +=				'</div>';
				dom +=				'<div class="uk-width-1-6 uk-vertical-align">';
				dom +=					'<div class="uk-panel uk-vertical-align-middle">';
				dom +=						Math.floor((cue.endTime - cue.startTime) * 100) / 100  + 's';
				dom +=					'</div>';
				dom +=				'</div>';
				dom +=				'<div class="uk-width-1-6">';
				dom +=					'<div class="uk-panel">';
				dom +=						'<button id="play_btn_' + i + '" class="uk-button uk-button-success sentence-play-button" type="button" style="display: none;">';
				dom +=							'<i class="uk-icon-play"></i>';
				dom +=						'</button>';
				dom +=					'</div>';
				dom +=				'</div>';
				dom +=				'<div class="uk-width-1-6">';
				dom +=					'<div class="uk-panel">';
				dom +=						'<button id="record_btn_' + i + '" class="uk-button uk-button-success sentence-record-button" type="button"' + (i == 0 ? '>' : ' disabled>');
				dom +=							'<i class="uk-icon-microphone"></i>';
				dom +=						'</button>';
				dom +=					'</div>';
				dom +=				'</div>';
				dom +=				'<div id="audio_data_' + i + '" style="display: none;">'; // 在里存放录音的声音。
				dom +=				'</div>';
				dom +=			'</div>';

				dom +=		'</div>';
				dom +=	'</div>';
				dom += '</div>';

				jq('#sutitle_list').append(dom);

				// 设置句子的播放和录音回调。
				jq('#play_btn_' + i).click(onPlayBtnClick);
				jq('#record_btn_' + i).click(onRecordBtnClick);
				

			}
		}
		
		//origTrack.mode = 'hidden';
		//transTrack.mode = 'hidden';

		// 定位于列表开始
		UIkit.Utils.scrollToElement(jq('#sentence_0'), {
			offset: $('#sentence_0').offset().top
		});

		sentencePlay(0);
		
		// 监听触屏拖动。
		dragSwitchSentence.init();
	}
});

// 使用自己的大播放按钮，点击时暂停和播放视频。
function dummyBigPlayBtnPlugin(options) {        
	var playBtn = document.createElement('div');
	playBtn.className = 'vjs-big-play-button';
	playBtn.innerHTML = '<span aria-hidden="true" class="vjs-icon-placeholder"></span><span class="vjs-control-text" aria-live="polite">Play Video</span>';
	player.el().appendChild(playBtn);
	playBtn.onclick = function (e) {
		onUserActive();
	};
	

};
videojs.registerPlugin('dummyBigPlayBtnPlugin', dummyBigPlayBtnPlugin);
player.dummyBigPlayBtnPlugin({});    


// 点击视频时，暂停和播放视频。
function onUserActive() {
	if (playStatus == 0) {
		if (jq(".vjs-big-play-button").css("display") == "block") {
			console.log("userinactive");

			//恢复播放并隐藏大播放按钮和控制条
			player.muted(false);
			player.play();
			jq(".vjs-big-play-button").css("display","none");
			jq(".vjs-control-bar").css("opacity","0");
		}
		else {
			console.log("useractive");

			//点击屏幕后暂停并显示大播放按钮和控制条
			player.pause();
			jq(".vjs-big-play-button").css("display","block");
			jq(".vjs-control-bar").css("opacity","1");
		}
	}
}

player.userActive(false);
player.on("useractive", onUserActive);
player.on("userinactive", onUserActive);

// 停止录音或录音回放。
function stopRecordOrPlay()
{
	if (playStatus == 1) {
		// 停止播放视频和录音。
		onStopRecord();
	}
	else if (playStatus == 2) {
		// 录音回放完毕，停止播放。
		player.pause();

		jq(".vjs-big-play-button").css("display","block");
		jq(".vjs-control-bar").css("opacity","1");

		if (accompanyPlayer != null) {
			accompanyPlayer.pause();
		}
		if (recordPlayer != null) {
			recordPlayer.pause();
		}
		playStatus = 0;
	}
}

// 限制视频播放区间。
player.on('timeupdate', function() {
	if (player.currentTime() >= sentenceEndTime) {
		player.currentTime(sentenceStartTime);
		stopRecordOrPlay();
	}
});

// 设置播放区间到句子的时间范围内。
var sentenceTimer = null;
function sentencePlay(index) {
	//console.log("sentencePlay:", index);

	if (index != subtitleCurrent) {
		//console.log("sentence new:", index);

		// 切换句子之前关闭录音和录音回放。
		bPlayAfterRecord = false;
		stopRecordOrPlay();

		// 等待录音完成后，才能切换。因为保存录音是在一个后台work中，
		// 不等待保存录音就切换，录音会保存到切换后的句子上。
		// 使用定时器的方法来轮询录音状态，只在录音完成后，才执行真正的句子切换。
		if (sentenceTimer != null) {
			window.clearInterval(sentenceTimer);
			sentenceTimer = null;
		}
		sentenceTimer = window.setInterval(function(){
			if (!isRecordStart) {
				//console.log("record has done.")
				window.clearInterval(sentenceTimer);
				sentenceTimer = null;
				
				// 禁用之前句子的录音按钮，并使能当前句子的录音按钮。
				$('#record_btn_' + subtitleCurrent).attr('disabled', '1');
				subtitleCurrent = index;
				$('#record_btn_' + subtitleCurrent).removeAttr('disabled');

				// 播放视频
				sentenceStartTime = $('#sentence_' + subtitleCurrent).attr('startTime');
				sentenceEndTime = $('#sentence_' + subtitleCurrent).attr('endTime');
				player.currentTime(sentenceStartTime);
				player.muted(false);
				player.play();
				jq(".vjs-big-play-button").css("display","none");
				jq(".vjs-control-bar").css("opacity","0");
			}
			else {
				//console.log("record hasn't done.")
			}
		}, 100);
	}
}

///////////////////////////////////////////////////////////////////////////////////
// 句子列表滚动

// 监听触屏：结束拖动名子列表时，切换句子。
var dragSwitchSentence = {
	isInTouch : false,
	isInScroll : false,

	init : function() {
		var pos = {};
		var status = false;
		var _self = this;

		$('body').on('touchstart', function(e) {
			//console.log('touchstart');

			e = mygetnativeevent(e);
			pos.startx = e.touches[0].clientX;
			pos.starty = e.touches[0].clientY;
			_self.isInTouch = true;
		})
		.on('touchmove', function(e) {
			//console.log('touchmove');

			e = mygetnativeevent(e);
			pos.curposx = e.touches[0].clientX;
			pos.curposy = e.touches[0].clientY;

			// 垂直方向移动距离超过50，确认开始滚动。
			var pullheight = pos.curposy - pos.starty;
			if (!status && Math.abs(pullheight) > 50) {
				status = true;

				// 拖动开始，停止录音和录音回放。
				stopRecordOrPlay();
			}
		})
		.on('touchend', function(e) {
			//console.log('touchend');

			_self.isInTouch = false;

			// 拖动结束，准备切换句子。
			if (pos.curposy != pos.starty){
				onScrollStop();
			}

			status = false;
			pos = {};
		});

		// 滚动结束事件处理
		// 句子列表滚动结束后进行对齐和切换当前句子。
		function onScrollStop(e) {
			//console.log('onScrollStop');

			if (dragSwitchSentence.isInScroll) {
				dragSwitchSentence.isInScroll = false;
			}

			if (!dragSwitchSentence.isInTouch && subtitleCount > 0) {
				var x, h;
				var i;
				var top = $('#sentence_0').offset().top;
				var align = $(window).scrollTop() + top;

				for (i = 0; i < subtitleCount; i++) {
					x = $('#sentence_' + i).offset().top;
					h = $('#sentence_' + i).outerHeight();

					if (align >= x && align < (x + h)) {

						if (align <= x + h / 2) {
							// 向上对齐当前
							UIkit.Utils.scrollToElement(jq('#sentence_' + i), {
								offset: top
							});
							
							sentencePlay(i);
						}
						else {
							// 向下对齐下一个
							if (i < (subtitleCount - 1)) {
								UIkit.Utils.scrollToElement(jq('#sentence_' + (i + 1)), {
									offset: top
								});
							}
							
							sentencePlay(i + 1);
						}

						break;
					}
				}
			}
		};

		// 监听滚动事件，在滚动结束时处理。
		var scrollTimer = null;
		document.onscroll = function() {
			//console.log('scroll');
			if (dragSwitchSentence.isInTouch) {
				return;
			}
			dragSwitchSentence.isInScroll = true;

			if (scrollTimer != null){
			   window.clearTimeout(scrollTimer);
			}

			window.canAutoScroll = false;
			//500ms后，假定认为停止滚动
			scrollTimer = window.setTimeout(function() {
				dragSwitchSentence.isInScroll = false;
				onScrollStop();
			}, 500);
		};
	}
};

////////////////////////////////////////////////////////////////
// 录音
var isRecordStart = false;
var bPlayAfterRecord = false;
var waitRecordStopTimer = null;

//唯一影响mp3文件大小的参数为 bitRate
//sampleRate 仅供特殊需求的人使用
var recorder = new MP3Recorder({
	WORKER_PATH: 'source/plugin/zhikai_n5video/mp3-recorder/recorder-worker.js',
	//numChannels: 1,     //声道数,默认为1
	//sampleRate: 8000,   //采样率,一般由设备提供,比如 48000
	bitRate: 64,        //比特率,不要低于64,否则可能录制无声音（人声）

	//录音结束事件
	complete: function (data, type) {
		var blob = new Blob(data, { type: type });
		if (blob.size > 0) {
			var url = URL.createObjectURL(blob);
			var mp3Name = 'recording_' + Date.now() + '.mp3';

			// 保存句子声音数据
			jq('#audio_data_' + subtitleCurrent).html('').
				append('<a href="' + url + '" download="' + mp3Name + '">' + mp3Name + '</a>').
				append('<audio controls src="' + url + '" id="record_audio_' + subtitleCurrent + '"></audio>');

			// 显示句子播放按钮
			jq('#play_btn_' + subtitleCurrent).css('display', 'inline-block');
			
			// 录音完成。
			isRecordStart = false;

			if (bPlayAfterRecord) {
				// 录完后自动播放用户的录音。
				var sentence = jq('#sentence_' + subtitleCurrent);
				var event = {data: {index: subtitleCurrent, startTime: sentence.attr('startTime'), endTime: sentence.attr('endTime')}};
				jq('#play_btn_' + subtitleCurrent).trigger('click', event);
			}
			else {
				playStatus = 0;
			}
		}

	},

	error: function (data) {
		console.log("encode error.");
	}
});


// 录音时间到结束录音
function onStopRecord() {
	if (isRecordStart) {
		// 停止视频播放
		player.pause();

		//停止录音，触发complete()。
		recorder.stop();

		// 进度条动画在当前位置停止。
		var elem = jq('#record_progress_' + subtitleCurrent);
		elem.css('transition', 'width 0s linear');
		elem.css('width', ' ' + elem[0].offsetWidth + 'px');
	}
}

//输出错误信息
function writeError(msg) {
	console.log(msg);
}

if (!recorder.support) writeError("您的浏览器不支持HTML5录音！");

function onRecordStart() {
	if (playStatus == 1) {
		//提示音结束后开始录音和播放视频（已经静音）
		recorder.start(function () {
			// 开始录音动画
			jq('#record_progress_' + subtitleCurrent).css('transition', 'width ' + (sentenceEndTime - sentenceStartTime) + 's linear');
			jq('#record_progress_' + subtitleCurrent).css('width', '100%');

			player.play();
		}, function (e) {
			switch (e.code || e.name) {
				case 'PERMISSION_DENIED':
				case 'PermissionDeniedError':
					writeError('用户拒绝提供设备。');
					break;
				case 'NOT_SUPPORTED_ERROR':
				case 'NotSupportedError':
					writeError('浏览器不支持硬件设备。');
					break;
				case 'MANDATORY_UNSATISFIED_ERROR':
				case 'MandatoryUnsatisfiedError':
					writeError('无法发现指定的硬件设备。');
					break;
				default:
					writeError('无法打开麦克风。异常信息:' + (e.code || e.name));
					break;
			}
		});
	}
}
startRecordSnd.addEventListener('ended', onRecordStart, false);

// 当前句子录音按钮按下
function onRecordBtnClick(event) {
	if (!recorder.support) return;

	if (!isRecordStart) {
		isRecordStart = true;
		bPlayAfterRecord = true;
		playStatus = 1;

		// 隐藏播放按钮。
		jq('#play_btn_' + subtitleCurrent).css('display', 'none');

		// 让视频静音播放。
		player.currentTime(sentenceStartTime);
		player.muted(true);
		jq(".vjs-big-play-button").css("display","none");
		jq(".vjs-control-bar").css("opacity","0");

		// 停止伴奏。
		if (accompanyPlayer != null) {
			accompanyPlayer.pause();
		}

		// 复位录音进度条。
		jq('#record_progress_' + subtitleCurrent).css('transition', 'width 0s');
		jq('#record_progress_' + subtitleCurrent).css('width', '0%');

		// 播放提示音,时长100ms。
		startRecordSnd.play();
		
	} else {
		//停止录音
		bPlayAfterRecord = false;
		onStopRecord();

		if (waitRecordStopTimer != null) {
			window.clearInterval(waitRecordStopTimer);
		}

		// 等待录音完成，再开始新的录音。
		waitRecordStopTimer = window.setInterval(function(){
			if (!isRecordStart) {
				//console.log("record has done.")
				window.clearInterval(waitRecordStopTimer);
				waitRecordStopTimer = null;

				onRecordBtnClick();
			}
			else {
				//console.log("record hasn't done.")
			}
		}, 100);
		
	}
}

// 当前句子录音回放按钮按下
function onPlayBtnClick(event) {
	//console.log("record playback.")
	playStatus = 2;

	// 让视频静音播放，并隐藏大播放按钮和控制条
	player.currentTime(sentenceStartTime);
	player.muted(true);
	jq(".vjs-big-play-button").css("display","none");
	jq(".vjs-control-bar").css("opacity","0");

	// 播放用户录音。
	recordPlayer = jq('#record_audio_' + subtitleCurrent)[0]; // 将jquery对象转换成js对象
	recordPlayer.currentTime = 0;

	// 重新播放伴奏和录音。
	if (accompanyPlayer != null) {
		accompanyPlayer.currentTime = sentenceStartTime;
		accompanyPlayer.play();
	}
	recordPlayer.play();
	player.play();
}


</script>


<!--{/block}-->